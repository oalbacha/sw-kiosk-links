<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Analytics Dashboard</title>
    <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        font-size: 28px;
        font-weight: 600;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .user-email {
        font-size: 14px;
        opacity: 0.9;
      }

      .logout-btn {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.3);
        color: white;
        padding: 8px 16px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
      }

      .logout-btn:hover {
        background: rgba(255, 255, 255, 0.3);
      }

      .content {
        padding: 40px;
      }

      .login-container {
        text-align: center;
        padding: 60px 20px;
      }

      .login-container h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 24px;
      }

      .login-container p {
        color: #666;
        margin-bottom: 30px;
      }

      #netlify-identity-widget {
        display: inline-block;
      }

      .loading {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .loading::after {
        content: "...";
        animation: dots 1.5s steps(4, end) infinite;
      }

      @keyframes dots {
        0%,
        20% {
          content: ".";
        }
        40% {
          content: "..";
        }
        60%,
        100% {
          content: "...";
        }
      }

      .error {
        background: #fee;
        color: #c33;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        border-left: 4px solid #c33;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 40px;
      }

      .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .stat-card h3 {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .stat-card .value {
        font-size: 36px;
        font-weight: 700;
      }

      .analytics-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }

      .analytics-table th {
        background: #f5f5f5;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #ddd;
      }

      .analytics-table td {
        padding: 15px;
        border-bottom: 1px solid #eee;
      }

      .analytics-table tr:hover {
        background: #f9f9f9;
      }

      .link-id {
        font-family: "Monaco", "Courier New", monospace;
        color: #667eea;
        font-weight: 600;
      }

      .count {
        font-size: 20px;
        font-weight: 600;
        color: #667eea;
      }

      .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .no-data-icon {
        font-size: 48px;
        margin-bottom: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸ“Š Analytics Dashboard</h1>
        <div class="user-info" id="userInfo" style="display: none">
          <span class="user-email" id="userEmail"></span>
          <button class="logout-btn" onclick="handleLogout()">Logout</button>
        </div>
      </div>

      <div class="content">
        <div id="loginContainer" class="login-container">
          <h2>Please log in to view analytics</h2>
          <p>You need to be authenticated to access the analytics data.</p>
          <div
            style="
              display: flex;
              gap: 10px;
              justify-content: center;
              margin-top: 20px;
            "
          >
            <button
              onclick="if(window.netlifyIdentity) { window.netlifyIdentity.open('login'); } else { alert('Netlify Identity is loading, please wait...'); }"
              style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 6px;
                font-size: 16px;
                cursor: pointer;
                font-weight: 600;
                transition: transform 0.2s;
              "
            >
              Log In
            </button>
            <button
              onclick="if(window.netlifyIdentity) { window.netlifyIdentity.open('signup'); } else { alert('Netlify Identity is loading, please wait...'); }"
              style="
                background: white;
                color: #667eea;
                border: 2px solid #667eea;
                padding: 12px 24px;
                border-radius: 6px;
                font-size: 16px;
                cursor: pointer;
                font-weight: 600;
                transition: transform 0.2s;
              "
            >
              Sign Up
            </button>
          </div>
          <div id="netlify-identity-widget"></div>
        </div>

        <div id="loadingContainer" class="loading" style="display: none">
          Loading analytics data
        </div>

        <div id="errorContainer" class="error" style="display: none"></div>

        <div id="analyticsContainer" style="display: none">
          <div class="stats-grid" id="statsGrid"></div>
          <table class="analytics-table" id="analyticsTable">
            <thead>
              <tr>
                <th>Link ID</th>
                <th>Click Count</th>
              </tr>
            </thead>
            <tbody id="analyticsTableBody"></tbody>
          </table>
        </div>

        <div id="noDataContainer" class="no-data" style="display: none">
          <div class="no-data-icon">ðŸ“­</div>
          <h3>No analytics data yet</h3>
          <p>Start clicking links to see analytics data appear here.</p>
        </div>
      </div>
    </div>

    <script>
      // Check for invite token in URL
      const hash = window.location.hash;
      const hasInviteToken = hash.includes('invite_token') || hash.includes('confirmation_token');
      
      // Initialize Netlify Identity
      function initIdentity() {
        if (window.netlifyIdentity) {
          // Initialize with the site URL
          window.netlifyIdentity.init();

          window.netlifyIdentity.on("init", (user) => {
            // If there's an invite token, the widget should automatically process it
            // Give it a moment to process, then check if we need to open it
            if (hasInviteToken && !user) {
              // The widget should automatically show the password setup form
              // But if it doesn't, we'll open it after a short delay
              setTimeout(() => {
                if (!window.netlifyIdentity.currentUser()) {
                  // Try opening signup to trigger the invite flow
                  window.netlifyIdentity.open('signup');
                }
              }, 500);
            } else if (user) {
              loadAnalytics();
            } else {
              showLogin();
            }
          });
          
          // Also listen for the invite event
          window.netlifyIdentity.on("invite", () => {
            // Widget is processing invite, it should show password form
          });

          window.netlifyIdentity.on("login", (user) => {
            window.netlifyIdentity.close();
            loadAnalytics();
          });

          window.netlifyIdentity.on("signup", (user) => {
            // After signup/password setup, close and load analytics
            window.netlifyIdentity.close();
            if (user) {
              loadAnalytics();
            }
          });

          window.netlifyIdentity.on("logout", () => {
            showLogin();
          });
        } else {
          // If widget hasn't loaded yet, wait for it
          setTimeout(initIdentity, 100);
        }
      }

      // Start initialization
      if (window.netlifyIdentity) {
        initIdentity();
      } else {
        // Wait for script to load
        window.addEventListener("load", function () {
          initIdentity();
        });
      }

      function showLogin() {
        document.getElementById("loginContainer").style.display = "block";
        document.getElementById("loadingContainer").style.display = "none";
        document.getElementById("analyticsContainer").style.display = "none";
        document.getElementById("noDataContainer").style.display = "none";
        document.getElementById("errorContainer").style.display = "none";
        document.getElementById("userInfo").style.display = "none";
      }

      function showLoading() {
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("loadingContainer").style.display = "block";
        document.getElementById("analyticsContainer").style.display = "none";
        document.getElementById("noDataContainer").style.display = "none";
        document.getElementById("errorContainer").style.display = "none";
      }

      function showError(message) {
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("loadingContainer").style.display = "none";
        document.getElementById("analyticsContainer").style.display = "none";
        document.getElementById("noDataContainer").style.display = "none";
        document.getElementById("errorContainer").style.display = "block";
        document.getElementById("errorContainer").textContent = message;
      }

      function showAnalytics(data) {
        document.getElementById("loginContainer").style.display = "none";
        document.getElementById("loadingContainer").style.display = "none";
        document.getElementById("errorContainer").style.display = "none";

        const user = window.netlifyIdentity?.currentUser();
        if (user) {
          document.getElementById("userEmail").textContent = user.email;
          document.getElementById("userInfo").style.display = "flex";
        }

        const entries = Object.entries(data);

        if (entries.length === 0) {
          document.getElementById("noDataContainer").style.display = "block";
          document.getElementById("analyticsContainer").style.display = "none";
          return;
        }

        document.getElementById("noDataContainer").style.display = "none";
        document.getElementById("analyticsContainer").style.display = "block";

        // Calculate total clicks
        const totalClicks = entries.reduce((sum, [_, count]) => sum + count, 0);
        const totalLinks = entries.length;

        // Display stats
        const statsGrid = document.getElementById("statsGrid");
        statsGrid.innerHTML = `
                <div class="stat-card">
                    <h3>Total Clicks</h3>
                    <div class="value">${totalClicks}</div>
                </div>
                <div class="stat-card">
                    <h3>Total Links</h3>
                    <div class="value">${totalLinks}</div>
                </div>
                <div class="stat-card">
                    <h3>Average Clicks</h3>
                    <div class="value">${
                      totalLinks > 0 ? Math.round(totalClicks / totalLinks) : 0
                    }</div>
                </div>
            `;

        // Display table
        const tableBody = document.getElementById("analyticsTableBody");
        tableBody.innerHTML = entries
          .sort((a, b) => b[1] - a[1]) // Sort by count descending
          .map(
            ([linkId, count]) => `
                    <tr>
                        <td><span class="link-id">${linkId}</span></td>
                        <td><span class="count">${count}</span></td>
                    </tr>
                `
          )
          .join("");
      }

      async function loadAnalytics() {
        showLoading();

        const user = window.netlifyIdentity?.currentUser();
        if (!user) {
          showLogin();
          return;
        }

        try {
          // Get the JWT token
          const token = await user.jwt();

          const response = await fetch("/api/analytics", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.status === 401) {
            showError("Unauthorized. Please log in again.");
            window.netlifyIdentity?.logout();
            return;
          }

          if (!response.ok) {
            throw new Error(`Failed to load analytics: ${response.statusText}`);
          }

          const data = await response.json();
          showAnalytics(data);
        } catch (error) {
          console.error("Error loading analytics:", error);
          showError(`Error loading analytics: ${error.message}`);
        }
      }

      function handleLogout() {
        window.netlifyIdentity?.logout();
      }
    </script>
  </body>
</html>
